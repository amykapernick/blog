---
import Layout from "../layouts/post.astro";

export async function getStaticPaths() {
	const posts = await Astro.glob("../../posts/**/*.md");
	const videos = await Astro.glob("../../videos/**/*.md");

	const allPosts = [];

	posts.forEach((post) => {
		if (post?.frontmatter?.external) return;

		const matches = post.file.match(/\/(?<slug>(?:\w|\w|-)+)\.md$/i);
		const { slug } = matches?.groups;

		allPosts.push({ params: { slug } });
	});

	videos.forEach((post) => {
		if (post?.frontmatter?.external) return;

		const matches = post.file.match(/\/(?<slug>(?:\w|\w|-)+)\.md$/i);
		const { slug } = matches?.groups;

		allPosts.push({ params: { slug } });
	});

	return allPosts;
}

const { slug } = Astro.params;

const posts = await Astro.glob("../../posts/**/*.md");
const videos = await Astro.glob("../../videos/**/*.md");

const post = [...posts, ...videos].find(({ file }) =>
	new RegExp(`${slug}.md`, "i").test(file)
);

const { frontmatter } = post;

const postContent = {
	...frontmatter,
	slug,
};

if (frontmatter?.video && !postContent.categories.includes("video")) {
	postContent.categories.push("video");
}

const Content = post.Content;
---

<Layout content={postContent}>
	<Content />
</Layout>
